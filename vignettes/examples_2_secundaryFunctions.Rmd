---
title: "Secundary functions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Secundary functions}
  %\VignetteEngine{knitr::knitr}
  %\VignetteEncoding{UTF-8}
---

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">


### <i class="fas fa-truck-loading"></i> Prepare data for examples

#### Vector data

```R
## Generate a binary vector -------------------------------------------------------------
vec.a <- sample(c(0, 1), 100, replace = TRUE)

## Generate a 0-1000 vector (random drawing) --------------------------------------------
vec.b <- runif(100, min = 0, max = 1000)

## Generate a 0-1000 vector (biased drawing) --------------------------------------------
BiasedDrawing <- function(x, m1 = 300, sd1 = 200, m2 = 700, sd2 = 200) {
  return(ifelse(x < 0.5, rnorm(1, m1, sd1), rnorm(1, m2, sd2)))
}
vec.c <- sapply(vec.a, BiasedDrawing)
vec.c[which(vec.c < 0)] <- 0
vec.c[which(vec.c > 1000)] <- 1000

## Generate a 0-1000 vector (normal distribution) ---------------------------------------
vec.d <- rnorm(100, 500)
```

#### Observations & explanatory variables

```R
library(biomod2)
library(raster)
```

```R
## Create simple simulated data ---------------------------------------------------------
myResp.s <- sample(c(0, 1), 20, replace = TRUE)
myExpl.s <- data.frame(var1 = sample(c(0, 1), 100, replace = TRUE),
                       var2 = rnorm(100),
                       var3 = 1:100)
                       
## Create raster data -------------------------------------------------------------------
ras.1 <- ras.2 <- mask.out <- raster(nrows = 10, ncols = 10)
ras.1[] <- as.factor(rep(c(1, 2, 3, 4, 5), each = 20))
ras.2[] <- rnorm(100)
stk <- stack(ras.1, ras.2)
names(stk) <- c("varFact", "varNorm")

## define a mask for already sampled points
mask.out[1:40] <- 1

## define a list of masks where we want to sample in priority
mask.in <- list(ras.1, ras.1)
mask.in[[1]][1:80] <- NA ## only level 5 should be sampled in this mask
mask.in[[1]][21:80] <- NA ## only levels 1 and 5 should be sampled in this mask

## Load real data -----------------------------------------------------------------------
myFile <- system.file('external/species/mammals_table.csv', package = 'biomod2')
DataSpecies <- read.csv(myFile, row.names = 1)
myResp.r <- as.numeric(DataSpecies[, 'GuloGulo'])

myFiles <- paste0('external/bioclim/current/bio', c(3, 4, 7, 11, 12), '.grd')
myExpl.r <- raster::stack(system.file(myFiles, package = 'biomod2'))

myRespXY <- DataSpecies[which(myResp.r == 1), c('X_WGS84', 'Y_WGS84')]
myResp.v <- reclassify(subset(myExpl.r, 1, drop = TRUE), c(-Inf, Inf, 0))
myResp.v[cellFromXY(myResp.v, myRespXY)] <- 1
```


### <i class="fas fa-cog"></i> Secundary functions : vector data

#### Generate calibration / evaluatation datasets

```R
bm_SampleBinaryVector(ref = vec.a, ratio = 0.7)
```

<!-- #### Rescale values between 0-1 with a binomial GLM -->

<!-- ```R -->
<!-- vec.b_rescaled <- bm_Rescaler(dataToRescale = vec.b, -->
<!--                               name = "TEST", -->
<!--                               doModel = TRUE, -->
<!--                               ref = vec.a) -->
<!-- plot(vec.b, vec.b_rescaled) -->
<!-- abline(a = 0, b = 0.001, lty = 2) -->
<!-- ``` -->

#### Find optimal threshold for a specific evaluation metric

```R
bm_FindOptimStat(Stat = 'TSS', Fit = vec.b, Obs = vec.a)
bm_FindOptimStat(Stat = 'TSS', Fit = vec.c, Obs = vec.a, Nb.thresh.test = 100)
```

#### From continuous to binary / filtered vector

```R
vec.d_bin <- bm_BinaryTransformation(data = vec.d, threshold = 500)
vec.d_filt <- bm_BinaryTransformation(data = vec.d, threshold = 500, doFiltering = TRUE)
cbind(vec.d, vec.d_bin, vec.d_filt)
```



### <i class="fas fa-cogs"></i> Secundary functions : explanatory variables

#### Generate automatic formula

```R
bm_MakeFormula(respName = 'myResp.s',
               explVar = head(myExpl.s),
               type = 'quadratic',
               interaction.level = 0)
```

#### Sample all factor levels

```R
samp1 <- bm_SampleFactorLevels(stk, mask.out = mask.out)
samp2 <- bm_SampleFactorLevels(stk, mask.in = mask.in)
samp3 <- bm_SampleFactorLevels(stk, mask.out = mask.out, mask.in = mask.in)
```

#### Compute Species Range Envelop model

```R
# Compute SRE for several quantile values
sre.100 <- bm_SRE(Response = myResp.v,
                  Explanatory = myExpl.r,
                  NewData = myExpl.r,
                  Quant = 0)
sre.095 <- bm_SRE(Response = myResp.v,
                  Explanatory = myExpl.r,
                  NewData = myExpl.r,
                  Quant = 0.025)
sre.090 <- bm_SRE(Response = myResp.v,
                  Explanatory = myExpl.r,
                  NewData = myExpl.r,
                  Quant = 0.05)
  
# Visualize results
res <- stack(myResp.v, sre.100, sre.095, sre.090)
names(res) <- c("Original distribution", "Full data calibration", "Over 95 percent", "Over 90 percent")
plot(res, zlim = c(0, 1))
```

#### Compute variables importance

```R
mod <- glm(var1 ~ var2 + var3, data = myExpl.s)
bm_VariablesImportance(model = mod, 
                       data = myExpl.s[, c('var2', 'var3')],
                       method = "full_rand",
                       nb_rand = 3)
```

